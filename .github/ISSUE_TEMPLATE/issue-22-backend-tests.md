# Задача 22.1: Исправление тестов бэкенд-сервисов

## Описание проблемы
Неоптимальная архитектура сервисов затрудняет тестирование. Текущие проблемы:

1. Несогласованный подход к мокированию TypeORM репозиториев в тестах
2. Отсутствие типизации для базовых сущностей, вызывающее ошибки линтера
3. Разрозненные тестовые файлы, которые используют разные подходы к тестированию
4. Недостаточное покрытие тестами бизнес-логики

## Цель
Исправить все тесты бэкенд-сервисов, обеспечив:
- Единый подход к мокированию и тестированию
- Отсутствие ошибок линтера и типизации
- Высокое тестовое покрытие критичных функций

## План работ

### Этап 1: Унификация тестовых утилит
- [x] Добавить интерфейс `BaseEntity` с обязательными полями для TypeORM сущностей
- [x] Исправить типизацию в `typeorm-test-utils.ts`
- [x] Создать шаблоны тестов для сервисов и контроллеров

### Этап 2: Создание и исправление тестов
- [x] Исправить тесты для `EmailService`
- [x] Исправить тесты для `AuthService`
- [x] Исправить тесты для `UserService`
- [ ] Разработать тесты для `LegalConsentService`
- [ ] Разработать тесты для `VendorService`
- [ ] Разработать тесты для `DmcaReportService`

### Этап 3: Проверка и документация
- [ ] Запустить все тесты и убедиться в отсутствии ошибок
- [ ] Проверить покрытие кода тестами (цель: > 80%)
- [ ] Обновить документацию в `TROUBLESHOOTING.md`
- [ ] Внести результаты в отчет о прогрессе спринта

## Критерии приемки
1. Все тесты успешно запускаются
2. Нет ошибок линтера
3. Тестовое покрытие > 80%
4. Документированы подходы к тестированию

## Технические детали

### Текущие проблемы с утилитами для тестирования

1. Ошибки типизации:
```
Property 'id' does not exist on type 'T'
Property 'updatedAt' does not exist on type 'T'
```

2. Несогласованность в подходах к мокированию:
- Разные файлы используют разные подходы (jest.mock, класс-заменители, прямое создание моков)

### Принятые решения

1. Использовать единый подход с TypeOrmServiceMockTemplate
2. Добавить интерфейс BaseEntity для унификации типов
3. Создать шаблоны для тестирования сервисов

### Прогресс

1. ✅ Добавлен интерфейс `BaseEntity` с поддержкой id типа number и string
2. ✅ Исправлена типизация во всех утилитах для тестирования
3. ✅ Исправлены тесты для EmailService с использованием нового подхода
4. ✅ Исправлены тесты для AuthService с использованием нового подхода
5. ✅ Созданы и успешно пройдены тесты для UserService (17 тестов) с использованием нашего нового подхода
6. ⏳ Работа над исправлением тестов для LegalConsentService

## Связанные задачи
- Основная задача: #22 Критические проблемы с тестированием
- Связано с: #17 Доработка LegalConsentService
- Связано с: #19 Тесты для EmailService 